CREATE TABLE Croyant(
   id INT IDENTITY,
   nom VARCHAR(100)  NOT NULL,
   prenom VARCHAR(100)  NOT NULL,
   date_naissance DATE NOT NULL,
   email VARCHAR(50)  NOT NULL,
   mot_de_passe VARCHAR(254)  NOT NULL,
   PRIMARY KEY(id)
);
CREATE TABLE Eglise(
   id INT IDENTITY,
   nom VARCHAR(100)  NOT NULL,
   PRIMARY KEY(id),
   UNIQUE(nom)
);
CREATE TABLE Offrande(
   id INT IDENTITY,
   montant DECIMAL(18,2)   NOT NULL,
   numero_dimanche SMALLINT NOT NULL,
   annee BIGINT NOT NULL,
   nombre INT NOT NULL,
   id_eglise INT,
   UNIQUE(numero_dimanche,annee),
   PRIMARY KEY(id),
   FOREIGN KEY(id_eglise) REFERENCES Eglise(id)
);
CREATE TABLE Historique_solde(
   id INT IDENTITY,
   solde DECIMAL(18,2)   NOT NULL,
   date_historique DATE NOT NULL,
   id_eglise INT,
   PRIMARY KEY(id),
   FOREIGN KEY(id_eglise) REFERENCES Eglise(id)
);

CREATE VIEW v_info_eglise AS 
	SELECT h.id_eglise,MAX(e.nom) AS nom,MAX(solde) AS solde, MAX(date_historique) AS date_solde 
		FROM historique_solde h 
		JOIN eglise e 
		ON h.id_eglise = e.id 
		GROUP BY h.id_eglise
;

CREATE TABLE Pret(
   id INT IDENTITY,
   numero_dimanche INT NOT NULL,
   annee INT NOT NULL,
   montant DECIMAL(18,2)   NOT NULL,
   id_eglise INT,
   id_croyant INT,
   date_pret DATETIME DEFAULT NOW(),
   PRIMARY KEY(id),
   UNIQUE(date_pret),
   CHECK(numero_dimanche <= 52 && numero_dimanche >= 1)
   FOREIGN KEY(id_eglise) REFERENCES Eglise(id),
   FOREIGN KEY(id_croyant) REFERENCES Croyant(id)
);


INSERT INTO Croyant(nom,prenom,date_naissance,email,mot_de_passe) VALUES 
    ('Ravelonarivo','Sanda','2005-07-12','sanda@gmail.com','admin')
;
INSERT INTO Eglise(nom) VALUES 
    ('FJKM Antanambao'),
    ('FJKM Ikianja'),
    ('FJKM Ankadidambo')
;

INSERT INTO offrande(montant,numero_dimanche,annee,nombre,id_eglise) VALUES 
    (205534,1,2022,297,1),
    (206588,2,2022,373,1),
    (379808,3,2022,231,1),
    (281296,4,2022,254,1),
    (271690,5,2022,250,1),
    (207712,6,2022,245,1),
    (274865,7,2022,189,1),
    (209149,8,2022,313,1),
    (225522,9,2022,229,1),
    (449910,10,2022,452,1),
    (322793,11,2022,218,1),
    (278560,12,2022,220,1),
    (295087,13,2022,169,1),
    (277571,14,2022,363,1),
    (250552,15,2022,415,1),
    (376494,16,2022,247,1),
    (425501,17,2022,342,1),
    (357440,18,2022,313,1),
    (364479,19,2022,178,1),
    (228670,20,2022,443,1),
    (219175,21,2022,233,1),
    (246491,22,2022,474,1),
    (319913,23,2022,322,1),
    (375001,24,2022,264,1),
    (137952,25,2022,132,1),
    (395978,26,2022,291,1),
    (366452,27,2022,465,1),
    (148847,28,2022,343,1),
    (266579,29,2022,339,1),
    (347388,30,2022,384,1),
    (257432,31,2022,193,1),
    (335929,32,2022,383,1),
    (282079,33,2022,423,1),
    (286004,34,2022,108,1),
    (255103,35,2022,389,1),
    (231002,36,2022,260,1),
    (199176,37,2022,245,1),
    (307518,38,2022,450,1),
    (411533,39,2022,329,1),
    (415421,40,2022,212,1),
    (283854,41,2022,378,1),
    (124945,42,2022,453,1),
    (334010,43,2022,100,1),
    (131973,44,2022,363,1),
    (132181,45,2022,398,1),
    (259302,46,2022,104,1),
    (218483,47,2022,290,1),
    (146514,48,2022,450,1),
    (327403,49,2022,311,1),
    (356036,50,2022,187,1),
    (135174,51,2022,138,1),
    (311474,52,2022,349,1),
    (252190,1,2023,314,1),
    (212084,2,2023,312,1),
    (357180,3,2023,238,1),
    (403211,4,2023,402,1),
    (342434,5,2023,222,1),
    (221049,6,2023,242,1),
    (129848,7,2023,101,1),
    (259235,8,2023,229,1),
    (170078,9,2023,296,1),
    (294233,10,2023,182,1),
    (125400,11,2023,480,1),
    (431112,12,2023,438,1),
    (359412,13,2023,285,1),
    (332721,14,2023,455,1),
    (178198,15,2023,250,1),
    (279023,16,2023,362,1),
    (391050,17,2023,199,1),
    (164379,18,2023,367,1),
    (176293,19,2023,263,1),
    (370010,20,2023,307,1),
    (333764,21,2023,447,1),
    (390840,22,2023,450,1),
    (174151,23,2023,420,1),
    (264010,24,2023,128,1),
    (434127,25,2023,429,1),
    (121936,26,2023,234,1),
    (189991,27,2023,373,1),
    (222585,28,2023,329,1),
    (126648,29,2023,118,1),
    (163955,30,2023,171,1),
    (352293,31,2023,126,1),
    (294739,32,2023,237,1),
    (380008,33,2023,330,1),
    (354307,34,2023,371,1),
    (154850,35,2023,235,1),
    (222395,36,2023,453,1),
    (330460,37,2023,475,1),
    (357089,38,2023,140,1),
    (182718,39,2023,398,1),
    (222083,40,2023,100,1),
    (295575,41,2023,253,1),
    (304846,42,2023,328,1),
    (362155,43,2023,186,1),
    (345580,44,2023,372,1),
    (444695,45,2023,362,1),
    (235370,46,2023,118,1),
    (377001,47,2023,484,1),
    (247461,48,2023,422,1),
    (245741,49,2023,319,1),
    (395235,50,2023,197,1),
    (384337,51,2023,342,1),
    (369011,52,2023,407,1)
;

INSERT INTO historique_solde(solde,date_historique,id_eglise) VALUES
   (205534,'2022-01-02',1),
   (412122,'2022-01-09',1),
   (791930,'2022-01-16',1),
   (1073226,'2022-01-23',1),
   (1344916,'2022-01-30',1),
   (1552628,'2022-02-06',1),
   (1827493,'2022-02-13',1),
   (2036642,'2022-02-20',1),
   (2262164,'2022-02-27',1),
   (2712074,'2022-03-06',1),
   (3034867,'2022-03-13',1),
   (3313427,'2022-03-20',1),
   (3608514,'2022-03-27',1),
   (3886085,'2022-04-03',1),
   (4136637,'2022-04-10',1),
   (4513131,'2022-04-17',1),
   (4938632,'2022-04-24',1),
   (5296072,'2022-05-01',1),
   (5660551,'2022-05-08',1),
   (5889221,'2022-05-15',1),
   (6108396,'2022-05-22',1),
   (6354887,'2022-05-29',1),
   (6674800,'2022-06-05',1),
   (7049801,'2022-06-12',1),
   (7187753,'2022-06-19',1),
   (7583731,'2022-06-26',1),
   (7950183,'2022-07-03',1),
   (8099030,'2022-07-10',1),
   (8365609,'2022-07-17',1),
   (8712997,'2022-07-24',1),
   (8970429,'2022-07-31',1),
   (9306358,'2022-08-07',1),
   (9588437,'2022-08-14',1),
   (9874441,'2022-08-21',1),
   (10129544,'2022-08-28',1),
   (10360546,'2022-09-04',1),
   (10559722,'2022-09-11',1),
   (10867240,'2022-09-18',1),
   (11278773,'2022-09-25',1),
   (11694194,'2022-10-02',1),
   (11978048,'2022-10-09',1),
   (12102993,'2022-10-16',1),
   (12437003,'2022-10-23',1),
   (12568976,'2022-10-30',1),
   (12701157,'2022-11-06',1),
   (12960459,'2022-11-13',1),
   (13178942,'2022-11-20',1),
   (13325456,'2022-11-27',1),
   (13652859,'2022-12-04',1),
   (14008895,'2022-12-11',1),
   (14144069,'2022-12-18',1),
   (14455543,'2022-12-25',1),
   (14707733,'2023-01-01',1),
   (14919817,'2023-01-08',1),
   (15276997,'2023-01-15',1),
   (15680208,'2023-01-22',1),
   (16022642,'2023-01-29',1),
   (16243691,'2023-02-05',1),
   (16373539,'2023-02-12',1),
   (16632774,'2023-02-19',1),
   (16802852,'2023-02-26',1),
   (17097085,'2023-03-05',1),
   (17222485,'2023-03-12',1),
   (17653597,'2023-03-19',1),
   (18013009,'2023-03-26',1),
   (18345730,'2023-04-02',1),
   (18523928,'2023-04-09',1),
   (18802951,'2023-04-16',1),
   (19194001,'2023-04-23',1),
   (19358380,'2023-04-30',1),
   (19534673,'2023-05-07',1),
   (19904683,'2023-05-14',1),
   (20238447,'2023-05-21',1),
   (20629287,'2023-05-28',1),
   (20803438,'2023-06-04',1),
   (21067448,'2023-06-11',1),
   (21501575,'2023-06-18',1),
   (21623511,'2023-06-25',1),
   (21813502,'2023-07-02',1),
   (22036087,'2023-07-09',1),
   (22162735,'2023-07-16',1),
   (22326690,'2023-07-23',1),
   (22678983,'2023-07-30',1),
   (22973722,'2023-08-06',1),
   (23353730,'2023-08-13',1),
   (23708037,'2023-08-20',1),
   (23862887,'2023-08-27',1),
   (24085282,'2023-09-03',1),
   (24415742,'2023-09-10',1),
   (24772831,'2023-09-17',1),
   (24955549,'2023-09-24',1),
   (25177632,'2023-10-01',1),
   (25473207,'2023-10-08',1),
   (25778053,'2023-10-15',1),
   (26140208,'2023-10-22',1),
   (26485788,'2023-10-29',1),
   (26930483,'2023-11-05',1),
   (27165853,'2023-11-12',1),
   (27542854,'2023-11-19',1),
   (27790315,'2023-11-26',1),
   (28036056,'2023-12-03',1),
   (28431291,'2023-12-10',1),
   (28815628,'2023-12-17',1),
   (29184639,'2023-12-24',1)
;